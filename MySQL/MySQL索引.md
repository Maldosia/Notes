# MySQL索引

## 1、索引概述

优点：快速检索，减少I/O次数，加快分组和排序。

缺点：占用存储空间，索引的维护和创建需要时间成本，随着数据量增大而增大，构建索引回降低数据表的修改操作(删除，添加，修改)的效率，因为在修改数据表的同时还需要修改索引，创建索引时需要<font color='red'>对表加锁</font>。

```plsql
-- 创建索引
ALTER TABLE my_table ADD [UNIQUE] INDEX INDEX_NAME(COLUMN_NAME);
-- 查看索引
SHOW INDEX FROM tablename;
-- 查看查询语句使用索引的情况
EXPLAIN SELECT * FROM TABLE_NAME WHERE COLUMN_1 = '123';

-- 常见索引
-- 1、主键索引，不允许重复，不允许空值
ALTER TABLE 'table_name' ADD PRIMARY KEY PK_INDEX('col');
-- 2、唯一索引
ALTER TABLE 'table_name' ADD UNIQUE index_name('col');
-- 3、唯一索引
ALTER TABLE 'table_name' ADD INDEX index_name('col');
-- 4、组合索引 遵循最左前缀原则,相当于建立了 col1、col1+col2、col1+col2+col3 三个索引
ALTER TABLE 'table_name' ADD INDEX index_name('col1','col2','col3');
```

## 2、多种索引

MySQL支持多种索引类型，BTree索引、<font color='red'>B+Tree索引</font>、<font color='red'>哈希索引</font>、全文索引等

### 2.1、哈希索引优缺点

优点：

```tex
索引的检索可以一次定位，故查询效率远高于B+Tree索引。
```

缺点：

```tex
仅仅只能满足“=”，而不能满足“IN”和“<=>”查询，不能使用范围查询，只适用于等值的过滤
无法利用索引的数据来排序，因为索引种存放的是Hash运算后的hash值，而hash值的大小关系并不和运算前一致
无法组合索引
```

## 3、Innodb和MyISAM

MySQL最常见的两种存储引擎分别是Innodb和MyISAM分别实现了聚簇索引和非聚簇索引

聚簇索引：聚簇索引的顺序就是数据的物理存储顺序。

非聚簇索引：索引的顺序和数据物理排序顺序无关。

主索引：使用主键键值建立的索引，只能有一个，辅助索引可以有多个。

### 3.1、MyISAM

- 非聚簇索引的<font color='red'>数据表和索引是分开存储的</font>

- 非聚簇索引的主索引和辅助索引几乎是一样的，只是主索引不允许重复，不允许空值，<font color='red'>叶子节点的key都存储指向键值对应的数据的物理地址</font>

### 3.1、Innodb

- 聚簇索引的<font color='red'>数据和主键索引存储在一起的</font>

- 聚簇索引中<font color='red'>主索引的叶子节点存储的是键值对应的数据本身</font>，<font color='red'>辅助索引的叶子节点存储的是键值对应的数据的主键键值</font>。
- Innodb要求表必须有主键
- 在B+Tree基础上做了优化，添加了指向相邻叶节点的指针，形成了带有顺序访问指针的B+Tree，提高了区间查找的效率
- 回表，如果在辅助索引中找到键值对，则会跟主键值再去主索引查找一次
- 默认每页大小16K(可修改)，Linux默认页大小4K。

```tex
叶子节点：假如每行记录大小为1K,则一个节点存储16个记录。
非叶子节点：假如主键占8B,指针占6B,则一个节点存储大约16*1024/14=1170个数据。
若树高两层，则最多大约存储1170*16=18720条数据
若树高三层，则最多大约存储1170*1170*16=2190万条数据
```

## 4、B+Tree特性

- 树高1-3，即I/O次数最多2次
- 查询速度更稳定，所有的数据查询都要查询至叶子节点，而叶子节点的高度都是相同的，因此所有数据的查询速度都是一致的

## 5、索引的使用策略

<font color='red'>什么时候要使用索引</font>：

- 主键自动建立唯一索引
- 经常作为查询条件在WHERE或者ORDER BY语句中出现的列要建立索引
- 作为排序的列要建立索引
- 高并发下倾向组合索引

<font color='red'>什么时候不使用索引</font>：

- 经常增删改的列不要建立索引
- 有大量重复值的列不要建立索引

<font color='red'>索引失效的情况</font>：

- 在组合索引中不能有列的值为NULL，如果有，那么这一列组合索引就是无效的
- 在LIKE操作中，‘%a%’不会使用索引，而‘a%’可以使用索引
- 在一个SELECT中，索引只能使用一次，如果在WHERE中使用了，那么在ORDER BY中就不要使用了

## 6、常见面试题

```tex
1、为什么MySQL的索引要用B+树而不用B树？
答：因为B树不管叶子还是非叶子节点，都会保存数据，导致在非叶子节点能保存的指针数量变少(有些资料也称为扇出)，只能增加树的高度，导致I/O操作变多，查询性能变低。
2、什么是回表？
答：先根据辅助索引定位主键值，再根据主键值查找主索引定位行记录。
3、什么是索引覆盖？
答：只需要在一棵索引树上就能获取SQL所需的所有列数据，无需回表。例如：在辅助索引树的叶子节点中，就已经包含了SQL需要的所有列数据，则覆盖索引。
```

